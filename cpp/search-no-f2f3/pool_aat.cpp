#include "field.h"
#include "cnpy.h"
#include "CLI11.hpp"

#include <iostream>
#include <vector>
#include <thread>
#include <atomic>
#include <mutex>
#include <random>
#include <chrono>
#include <condition_variable>
#include <algorithm>
#include <iomanip>
#include <optional>
#include <filesystem>
#include <cassert>


#include "scheme.h"
#include "utils_aat.h"
using FieldType = B3;

// Structure to hold a scheme and its metadata
template<typename Field>
struct SchemeData {
    std::vector<Field> data;
    int rank;
    U32 seed;  // Seed that generated this scheme
    
    SchemeData() : rank(0), seed(0) {}
    SchemeData(const std::vector<Field>& d, int r, U32 s) 
        : data(d), rank(r), seed(s) {}
};

// Save pool to file using cnpy
template<typename Field>
void save_pool(const std::vector<SchemeData<Field>>& pool, int rank, int n) {
    if (pool.empty()) return;
    
    // Create pool directory if it doesn't exist
    std::filesystem::create_directories("pool/" + suffix);
    
    // Prepare data for saving
    std::vector<U64> save_data;
    
    for (const auto& scheme : pool) {
        // Filter out zero elements (check only first component)
        std::vector<Field> nonzero_data;
        for (size_t i = 0; i < scheme.data.size(); i += 3) {
            if (!scheme.data[i].is_zero()) {
                nonzero_data.push_back(scheme.data[i]);
                nonzero_data.push_back(scheme.data[i+1]);
                nonzero_data.push_back(scheme.data[i+2]);
            }
        }
        
        // For B3, we need to save both lo and hi parts
        if constexpr (!field_traits<Field>::is_mod2) {
            for (const auto& f : nonzero_data) {
                B3 b3 = static_cast<B3>(f);
                save_data.push_back(b3.lo);
                save_data.push_back(b3.hi);
            }
        } else {
            // For B2, just save the value
            for (const auto& f : nonzero_data) {
                save_data.push_back(pack_field(f));
            }
        }
    }
    
    // Construct filename
    std::string field_name = field_traits<Field>::is_mod2 ? "mod2" : "mod3";
    std::string filename = "pool/" + suffix + "/" + "n" + std::to_string(n) + "_" + field_name + 
                          "_rank" + std::to_string(rank) + ".npy";
    
    // Calculate shape
    size_t elements_per_scheme = rank * 3;  // 3 components per non-zero summand
    if constexpr (!field_traits<Field>::is_mod2) {
        elements_per_scheme *= 2;  // lo and hi for B3
    }
    std::vector<size_t> shape = {pool.size(), elements_per_scheme};
    
    // Save using cnpy
    cnpy::npy_save(filename, save_data.data(), shape);
}

// Pool-based search algorithm
template<typename Field>
class PoolSearch {
private:
    int n;                    // Matrix size
    int path_limit;           // Length limit for random walks
    int pool_size;            // Target size for each pool
    int target_rank;          // Target rank to reach
    int plus_lim;             // Flips without improvement before plus
    int threads;              // Number of worker threads
    int max_attempts;         // Maximum attempts per rank level
    bool use_plus;            // Whether to use plus transitions
    bool save_pools;          // Whether to save pools
    
    std::mutex pool_mutex;
    std::mutex result_mutex;
    std::condition_variable pool_cv;
    std::atomic<bool> stop_workers{false};
    std::atomic<int> active_workers{0};
    std::atomic<int> attempts_made{0};
    
    std::vector<SchemeData<Field>> current_pool;
    std::vector<SchemeData<Field>> next_pool;
    
    std::mt19937 seed_gen;
    
public:
    PoolSearch(int n_, int path_lim, int pool_sz, int target, 
               int plus_l, int thr, int max_att, bool use_p, bool save_p)
        : n(n_), path_limit(path_lim), pool_size(pool_sz), 
          target_rank(target), plus_lim(plus_l), 
          threads(thr), max_attempts(max_att), use_plus(use_p), save_pools(save_p),
          seed_gen(std::random_device{}()) {}
    
    // Try to find a scheme of rank-1 from the given starting scheme
    std::optional<SchemeData<Field>> search_from_scheme(const SchemeData<Field>& start) {
        // Generate random seed for this search
        U32 search_seed = seed_gen();
        
        // Create scheme with the starting data
        Scheme<Field> scheme(start.data, search_seed);
        
        int current_rank = start.rank;
        int best_rank = current_rank;
        int flips_since_improvement = 0;
        
        // Main search loop
        for (int i = 0; i < path_limit; ++i) {
            if (!scheme.flip()) {
                // No more flips possible
                if (use_plus && !scheme.plus()) {
                    break;
                }
                flips_since_improvement = 0;
            }
            
            int new_rank = get_rank(scheme.get_data_field());
            
            // Found a scheme with rank-1!
            if (new_rank < current_rank) {
                return SchemeData<Field>(scheme.get_data_field(), new_rank, search_seed);
            }
            
            // Track improvement
            if (new_rank < best_rank) {
                best_rank = new_rank;
                flips_since_improvement = 0;
            } else {
                ++flips_since_improvement;
            }
            
            // Plus transition if stuck (and enabled)
            if (use_plus && flips_since_improvement >= plus_lim) {
                if (scheme.plus()) {
                    flips_since_improvement = 0;
                }
            }
        }
        
        return std::nullopt;
    }
    
    // Worker thread function
    void worker() {
        while (!stop_workers) {
            SchemeData<Field>* to_process = nullptr;
            
            // Get a scheme from the pool
            {
                std::unique_lock<std::mutex> lock(pool_mutex);
                pool_cv.wait(lock, [this] { 
                    return !current_pool.empty() || stop_workers; 
                });
                
                if (stop_workers) break;
                
                if (!current_pool.empty()) {
                    // Random selection from pool
                    std::uniform_int_distribution<size_t> dist(0, current_pool.size() - 1);
                    size_t idx = dist(seed_gen);
                    to_process = new SchemeData<Field>(current_pool[idx]);
                    active_workers++;
                    attempts_made++;
                }
            }
            
            if (to_process) {
                // Search from this scheme
                auto result = search_from_scheme(*to_process);
                
                if (result.has_value()) {
                    std::lock_guard<std::mutex> lock(result_mutex);
                    next_pool.push_back(*result);
                }
                
                delete to_process;
                active_workers--;
            }
        }
    }
    
    // Run pool-based search
    void run() {
        // Generate initial decomposition
        // auto initial_data_u64 = generate_trivial_decomposition(n);
        // std::vector<Field> initial_data;
        // initial_data.reserve(initial_data_u64.size());
        // for (U64 val : initial_data_u64) initial_data.push_back(field_traits<Field>::from_u64(val));

        std::vector<U64> data_raw = {526848ULL,131072ULL,67108864ULL,150994944ULL,0ULL,65536ULL,2059ULL,788228ULL,0ULL,262144ULL,6ULL,1ULL,0ULL,1ULL,262405ULL,514ULL,0ULL,1ULL,790020ULL,10ULL,0ULL,67108864ULL,66816ULL,0ULL,196864ULL,526848ULL,16777216ULL,0ULL,33280ULL,66560ULL,786432ULL,3072ULL,0ULL,3328ULL,34049ULL,65542ULL,10ULL,516ULL,67109376ULL,256ULL,0ULL,2163976ULL,512ULL,134348808ULL,0ULL,134217728ULL,2097152ULL,0ULL,520ULL,3ULL,16842752ULL,131072ULL,2097152ULL,33288ULL,1024ULL,2048ULL,1280ULL,67108864ULL,256ULL,0ULL,12ULL,1ULL,3084ULL,0ULL,0ULL,1ULL,33685506ULL,16777217ULL,16777216ULL,67108864ULL,0ULL,2097152ULL,33685506ULL,0ULL,67108864ULL,50331648ULL,0ULL,2097152ULL,786432ULL,3080ULL,0ULL,265472ULL,6ULL,32769ULL,1024ULL,786432ULL,67112192ULL,0ULL,65536ULL,1280ULL,8ULL,6ULL,768ULL,2ULL,1ULL,0ULL,512ULL,0ULL,33554688ULL,512ULL,2163720ULL,0ULL,4ULL,9ULL,265224ULL,518ULL,1ULL,0ULL,196608ULL,525056ULL,17301504ULL,327680ULL,1024ULL,98816ULL,512ULL,131080ULL,67174400ULL,167903232ULL,32776ULL,2097156ULL,131080ULL,513ULL,131072ULL,65536ULL,2097156ULL,8ULL,4ULL,10ULL,256ULL,512ULL,2163979ULL,0ULL,2824ULL,3ULL,17104896ULL,0ULL,33280ULL,0ULL,776ULL,1027ULL,0ULL,262400ULL,33286ULL,1ULL,83886081ULL,131598ULL,0ULL,67108864ULL,0ULL,2097152ULL,2ULL,520ULL,100794368ULL,16842752ULL,8ULL,2097152ULL,512ULL,131072ULL,167772160ULL,67108864ULL,32776ULL,65540ULL,3ULL,8ULL,256ULL,131072ULL,0ULL,33284ULL,8ULL,4ULL,262400ULL,1536ULL,2ULL,0ULL,198656ULL,525056ULL,327680ULL,524288ULL,33792ULL,66048ULL,720896ULL,2824ULL,589824ULL,262144ULL,0ULL,32768ULL,2048ULL,0ULL,17108224ULL,201850880ULL,65536ULL,1024ULL,8ULL,0ULL,168689664ULL,67112192ULL,4ULL,32768ULL,768ULL,1024ULL,0ULL,256ULL,1ULL,33542ULL,8429568ULL,2097152ULL,1073741824ULL,2415919104ULL,0ULL,65536ULL,32944ULL,12611648ULL,0ULL,4194304ULL,6ULL,1ULL,0ULL,16ULL,4198480ULL,8224ULL,0ULL,1ULL,12640320ULL,160ULL,0ULL,1073741824ULL,66816ULL,0ULL,3149824ULL,8429568ULL,268435456ULL,0ULL,33280ULL,66560ULL,12582912ULL,49152ULL,0ULL,53248ULL,34049ULL,65542ULL,160ULL,8256ULL,1073750016ULL,4096ULL,0ULL,2163976ULL,8192ULL,2149580928ULL,0ULL,2147483648ULL,2097152ULL,0ULL,8320ULL,48ULL,269484032ULL,2097152ULL,2097152ULL,33288ULL,16384ULL,32768ULL,20480ULL,1073741824ULL,256ULL,0ULL,192ULL,16ULL,49344ULL,0ULL,0ULL,1ULL,538968096ULL,268435472ULL,268435456ULL,1073741824ULL,0ULL,2097152ULL,538968096ULL,0ULL,1073741824ULL,805306368ULL,0ULL,2097152ULL,12582912ULL,49280ULL,0ULL,4247552ULL,6ULL,32769ULL,16384ULL,12582912ULL,1073795072ULL,0ULL,65536ULL,1280ULL,128ULL,96ULL,12288ULL,32ULL,1ULL,0ULL,8192ULL,0ULL,536875008ULL,8192ULL,2163720ULL,0ULL,64ULL,144ULL,4243584ULL,8288ULL,1ULL,0ULL,3145728ULL,8400896ULL,276824064ULL,5242880ULL,1024ULL,98816ULL,8192ULL,2097280ULL,1074790400ULL,2686451712ULL,32776ULL,2097156ULL,2097280ULL,8208ULL,2097152ULL,1048576ULL,2097156ULL,8ULL,64ULL,160ULL,4096ULL,8192ULL,2163979ULL,0ULL,45184ULL,48ULL,273678336ULL,0ULL,33280ULL,0ULL,12416ULL,16432ULL,0ULL,4198400ULL,33286ULL,1ULL,1342177296ULL,2105568ULL,0ULL,1073741824ULL,0ULL,2097152ULL,32ULL,8320ULL,1612709888ULL,269484032ULL,8ULL,2097152ULL,8192ULL,2097152ULL,2684354560ULL,1073741824ULL,32776ULL,65540ULL,48ULL,128ULL,4096ULL,2097152ULL,0ULL,33284ULL,128ULL,64ULL,4198400ULL,24576ULL,2ULL,0ULL,3178496ULL,8400896ULL,5242880ULL,8388608ULL,33792ULL,66048ULL,11534336ULL,45184ULL,9437184ULL,4194304ULL,0ULL,32768ULL,32768ULL,0ULL,273731584ULL,3229614080ULL,65536ULL,1024ULL,128ULL,0ULL,2699034624ULL,1073795072ULL,4ULL,32768ULL,12288ULL,16384ULL,0ULL,4096ULL,1ULL,33542ULL,234950158ULL,17694977ULL,51539607552ULL,0ULL,38010880ULL,9568256ULL,65792ULL,16777217ULL,72058693549555712ULL,144117387099111424ULL,144ULL,18432ULL,67372032ULL,4ULL,5497558138880ULL,0ULL,16785408ULL,8392704ULL,67371008ULL,134745100ULL,1130332313092096ULL,2251799813685248ULL,17330400ULL,34603008ULL,117901319ULL,134743816ULL,217017207043915776ULL,12884901888ULL,34603008ULL,0ULL,184812555ULL,67832580ULL,720586935495557120ULL,0ULL,8398848ULL,20975616ULL,134744064ULL,8ULL,2199023255552ULL,8796093022208ULL,262272ULL,1048608ULL,134678535ULL,117966600ULL,21474836480ULL,360287970189639680ULL,33570816ULL,0ULL,33688576ULL,16842764ULL,1012761264151068672ULL,72341328167436288ULL,8669280ULL,56242320ULL,65793ULL,16777216ULL,72340168526266368ULL,289360674105065472ULL,0ULL,1179792ULL,134678280ULL,117966855ULL,144117387099111424ULL,576469548396445696ULL,1048576ULL,128ULL,67765258ULL,16777472ULL,73187952120823808ULL,1011914640197681152ULL,33701904ULL,18620640ULL,67371012ULL,1024ULL,289356280353521664ULL,72339086194507776ULL,262176ULL,524352ULL,1028ULL,67371008ULL,2251816993554432ULL,1125934266580992ULL,8256ULL,4128ULL,16777477ULL,67437568ULL,1099511627776ULL,17179869184ULL,47863840ULL,17047760ULL,67830795ULL,184814340ULL,288230380446679040ULL,72057611217797120ULL,655440ULL,262176ULL,33686275ULL,16842752ULL,8589934592ULL,845524441759744ULL,51921024ULL,4333632ULL,16846350ULL,235798785ULL,42949672960ULL,2814749767106560ULL,8407040ULL,37752832ULL,16778250ULL,67764480ULL,1009947656845262848ULL,75154935473242112ULL,5271616ULL,59246720ULL,218956290ULL,33688845ULL,562984313159680ULL,2251808403619840ULL,64ULL,524288ULL,67108868ULL,263168ULL,864704322594668544ULL,0ULL,17039360ULL,8912896ULL,134547461ULL,33554944ULL,146093265328799744ULL,939009326989705216ULL,51404928ULL,524352ULL,134742024ULL,2048ULL,723390690146385920ULL,42949672960ULL,8404992ULL,33558528ULL,218956301ULL,33688834ULL,144678142324244480ULL,72339077604573184ULL,8192ULL,64ULL,67371011ULL,134742784ULL,289364019884589056ULL,795738572433915904ULL,21631184ULL,43280416ULL,34409741ULL,218235394ULL,868082022315196416ULL,0ULL,524288ULL,16777216ULL,33686018ULL,0ULL,847723465015296ULL,0ULL,0ULL,21626880ULL,33623052ULL,16908288ULL,1012762415202304000ULL,72340177116200960ULL,38539296ULL,26372304ULL,235802113ULL,16843022ULL,2199023255552ULL,1099511627776ULL,4240ULL,18464ULL,134744072ULL,0ULL,2260595906707456ULL,1130297953353728ULL,16512ULL,4128ULL,131074ULL,33554944ULL,144115192370823168ULL,72057602627862528ULL,80ULL,10240ULL,33556485ULL,134545920ULL,146369216977567744ULL,938733375340937216ULL,16793792ULL,35135488ULL,185273092ULL,67372043ULL,0ULL,3298534883328ULL,21626880ULL,8650752ULL,134482944ULL,67633164ULL,864699924548157440ULL,17179869184ULL,1851456ULL,58728576ULL,134480643ULL,67633152ULL,795741888148668416ULL,289360704169836544ULL,10102864ULL,54808736ULL,218959117ULL,33686018ULL,1412872441692160ULL,0ULL,16785408ULL,0ULL,131586ULL,33554432ULL,723401685262663680ULL,0ULL,20971520ULL,10240ULL,134873610ULL,33556480ULL,723399486239408128ULL,8589934592ULL,31080656ULL,33830944ULL,33554946ULL,131072ULL,34359738368ULL,8589934592ULL,80ULL,655360ULL,33620736ULL,16908291ULL,144117391394078720ULL,72057594037927936ULL,34103312ULL,17828032ULL,235802126ULL,16843009ULL,282574488338432ULL,1130297953353728ULL,1179792ULL,262176ULL,524296ULL,134219776ULL,51539607552ULL,864691128455135232ULL,9437184ULL,33816576ULL,16777473ULL,65536ULL,21474836480ULL,0ULL,0ULL,37767168ULL,67436805ULL,16778240ULL,289360678400032768ULL,72339069014638592ULL,55972016ULL,8939584ULL,184814347ULL,67830788ULL,34359738368ULL,17179869184ULL,10320ULL,4128ULL,134678279ULL,117966856ULL,289360674105065472ULL,578721348210130944ULL,16512ULL,0ULL,16842752ULL,257ULL,12884901888ULL,844424930131968ULL,0ULL,38928384ULL,134875136ULL,33554954ULL,2233382993920ULL,0ULL,55470208ULL,9441392ULL,3759202528ULL,283119632ULL,824633720832ULL,0ULL,38010880ULL,9568256ULL,1052672ULL,268435472ULL,1152939096792891392ULL,2305878193585782784ULL,144ULL,18432ULL,1077952512ULL,64ULL,87960930222080ULL,0ULL,16785408ULL,8392704ULL,1077936128ULL,2155921600ULL,18085317009473536ULL,36028797018963968ULL,17330400ULL,34603008ULL,1886421104ULL,2155901056ULL,3472275312702652416ULL,206158430208ULL,34603008ULL,0ULL,2957000880ULL,1085321280ULL,11529390967928913920ULL,0ULL,8398848ULL,20975616ULL,2155905024ULL,128ULL,35184372088832ULL,140737488355328ULL,262272ULL,1048608ULL,2154856560ULL,1887465600ULL,343597383680ULL,5764607523034234880ULL,33570816ULL,0ULL,539017216ULL,269484224ULL,16204180226417098752ULL,1157461250678980608ULL,8669280ULL,56242320ULL,1052688ULL,268435456ULL,1157442696420261888ULL,4629770785681047552ULL,0ULL,1179792ULL,2154852480ULL,1887469680ULL,2305878193585782784ULL,9223512774343131136ULL,1048576ULL,128ULL,1084244128ULL,268439552ULL,1171007233933180928ULL,16190634243162898432ULL,33701904ULL,18620640ULL,1077936192ULL,16384ULL,4629700485656346624ULL,1157425379112124416ULL,262176ULL,524352ULL,16448ULL,1077936128ULL,36029071896870912ULL,18014948265295872ULL,8256ULL,4128ULL,268439632ULL,1079001088ULL,17592186044416ULL,274877906944ULL,47863840ULL,17047760ULL,1085292720ULL,2957029440ULL,4611686087146864640ULL,1152921779484753920ULL,655440ULL,262176ULL,538980400ULL,269484032ULL,137438953472ULL,13528391068155904ULL,51921024ULL,4333632ULL,269541600ULL,3772780560ULL,687194767360ULL,45035996273704960ULL,8407040ULL,37752832ULL,268452000ULL,1084231680ULL,16159162509524205568ULL,1202478967571873792ULL,5271616ULL,59246720ULL,3503300640ULL,539021520ULL,9007749010554880ULL,36028934457917440ULL,64ULL,524288ULL,1073741888ULL,4210688ULL,13835269161514696704ULL,0ULL,17039360ULL,8912896ULL,2152759376ULL,536879104ULL,2337492245260795904ULL,15024149231835283456ULL,51404928ULL,524352ULL,2155872384ULL,32768ULL,11574251042342174720ULL,687194767360ULL,8404992ULL,33558528ULL,3503300816ULL,539021344ULL,2314850277187911680ULL,1157425241673170944ULL,8192ULL,64ULL,1077936176ULL,2155884544ULL,4629824318153424896ULL,12731817158942654464ULL,21631184ULL,43280416ULL,550555856ULL,3491766304ULL,13889312357043142656ULL,0ULL,524288ULL,16777216ULL,538976288ULL,0ULL,13563575440244736ULL,0ULL,0ULL,21626880ULL,537968832ULL,270532608ULL,16204198643236864000ULL,1157442833859215360ULL,38539296ULL,26372304ULL,3772833808ULL,269488352ULL,35184372088832ULL,17592186044416ULL,4240ULL,18464ULL,2155905152ULL,0ULL,36169534507319296ULL,18084767253659648ULL,16512ULL,4128ULL,2097184ULL,536879104ULL,2305843077933170688ULL,1152921642045800448ULL,80ULL,10240ULL,536903760ULL,2152734720ULL,2341907471641083904ULL,15019734005454995456ULL,16793792ULL,35135488ULL,2964369472ULL,1077952688ULL,0ULL,52776558133248ULL,21626880ULL,8650752ULL,2151727104ULL,1082130624ULL,13835198792770519040ULL,274877906944ULL,1851456ULL,58728576ULL,2151690288ULL,1082130432ULL,12731870210378694656ULL,4629771266717384704ULL,10102864ULL,54808736ULL,3503345872ULL,538976288ULL,22605959067074560ULL,0ULL,16785408ULL,0ULL,2105376ULL,536870912ULL,11574426964202618880ULL,0ULL,20971520ULL,10240ULL,2157977760ULL,536903680ULL,11574391779830530048ULL,137438953472ULL,31080656ULL,33830944ULL,536879136ULL,2097152ULL,549755813888ULL,137438953472ULL,80ULL,655360ULL,537931776ULL,270532656ULL,2305878262305259520ULL,1152921504606846976ULL,34103312ULL,17828032ULL,3772834016ULL,269488144ULL,4521191813414912ULL,18084767253659648ULL,1179792ULL,262176ULL,8388736ULL,2147516416ULL,824633720832ULL,13835058055282163712ULL,9437184ULL,33816576ULL,268439568ULL,1048576ULL,343597383680ULL,0ULL,0ULL,37767168ULL,1078988880ULL,268451840ULL,4629770854400524288ULL,1157425104234217472ULL,55972016ULL,8939584ULL,2957029552ULL,1085292608ULL,549755813888ULL,274877906944ULL,10320ULL,4128ULL,2154852464ULL,1887469696ULL,4629770785681047552ULL,9259541571362095104ULL,16512ULL,0ULL,269484032ULL,4112ULL,206158430208ULL,13510798882111488ULL,0ULL,38928384ULL,2158002176ULL,536879264ULL,35734127902720ULL,0ULL,55470208ULL,9441392ULL,2262794929963008ULL,562949953421312ULL,288230376151711744ULL,648518346341351424ULL,0ULL,17179869184ULL,8843337662464ULL,3385413481791488ULL,0ULL,1125899906842624ULL,402653184ULL,67108864ULL,0ULL,4294967296ULL,1127020893306880ULL,2207613190144ULL,0ULL,67108864ULL,3393110063185920ULL,42949672960ULL,0ULL,288230376151711744ULL,22548578304ULL,0ULL,845524441759744ULL,2262794929963008ULL,72057594037927936ULL,0ULL,10737418240ULL,21474836480ULL,3377699720527872ULL,13194139533312ULL,0ULL,14293651161088ULL,14025752576ULL,17582522368ULL,42949672960ULL,2216203124736ULL,288232575174967296ULL,1099511627776ULL,0ULL,57445187584ULL,2199023255552ULL,577023736616583168ULL,0ULL,576460752303423488ULL,34359738368ULL,0ULL,2233382993920ULL,12884901888ULL,72339069014638592ULL,562949953421312ULL,34359738368ULL,11274289152ULL,4398046511104ULL,8796093022208ULL,5497558138880ULL,288230376151711744ULL,1073741824ULL,0ULL,51539607552ULL,4294967296ULL,13245679140864ULL,0ULL,0ULL,67108864ULL,144678146619211776ULL,72057598332895232ULL,72057594037927936ULL,288230376151711744ULL,0ULL,34359738368ULL,144678146619211776ULL,0ULL,288230376151711744ULL,216172782113783808ULL,0ULL,34359738368ULL,3377699720527872ULL,13228499271680ULL,0ULL,1140193558003712ULL,402653184ULL,8657043456ULL,4398046511104ULL,3377699720527872ULL,288244669802872832ULL,0ULL,17179869184ULL,5368709120ULL,34359738368ULL,25769803776ULL,3298534883328ULL,8589934592ULL,67108864ULL,0ULL,2199023255552ULL,0ULL,144116287587483648ULL,2199023255552ULL,56371445760ULL,0ULL,17179869184ULL,38654705664ULL,1139128406114304ULL,2224793059328ULL,67108864ULL,0ULL,844424930131968ULL,2255098348568576ULL,74309393851613184ULL,1407374883553280ULL,4294967296ULL,27917287424ULL,2199023255552ULL,562984313159680ULL,288511851128422400ULL,721138890332700672ULL,9126805504ULL,34628173824ULL,562984313159680ULL,2203318222848ULL,562949953421312ULL,281474976710656ULL,34628173824ULL,536870912ULL,17179869184ULL,42949672960ULL,1099511627776ULL,2199023255552ULL,57646514176ULL,0ULL,12128987643904ULL,12884901888ULL,73464968921481216ULL,0ULL,10737418240ULL,0ULL,3332894621696ULL,4410931412992ULL,0ULL,1126999418470400ULL,11140071424ULL,67108864ULL,360287974484606976ULL,565209106219008ULL,0ULL,288230376151711744ULL,0ULL,34359738368ULL,8589934592ULL,2233382993920ULL,432908514180988928ULL,72339069014638592ULL,536870912ULL,34359738368ULL,2199023255552ULL,562949953421312ULL,720575940379279360ULL,288230376151711744ULL,9126805504ULL,17448304640ULL,12884901888ULL,34359738368ULL,1099511627776ULL,562949953421312ULL,0ULL,11005853696ULL,34359738368ULL,17179869184ULL,1126999418470400ULL,6597069766656ULL,134217728ULL,0ULL,853221023154176ULL,2255098348568576ULL,1407374883553280ULL,2251799813685248ULL,12884901888ULL,19327352832ULL,3096224743817216ULL,12128987643904ULL,2533274790395904ULL,1125899906842624ULL,0ULL,8589934592ULL,8796093022208ULL,0ULL,73479262572642304ULL,866942928268820480ULL,17179869184ULL,4294967296ULL,34359738368ULL,0ULL,724516590053228544ULL,288244669802872832ULL,268435456ULL,8589934592ULL,3298534883328ULL,4398046511104ULL,0ULL,1099511627776ULL,67108864ULL,12213813248ULL,36204718879408128ULL,9007199254740992ULL,4611686018427387904ULL,10376293541461622784ULL,0ULL,17179869184ULL,141493402599424ULL,54166615708663808ULL,0ULL,18014398509481984ULL,402653184ULL,67108864ULL,0ULL,68719476736ULL,18032334292910080ULL,35321811042304ULL,0ULL,67108864ULL,54289761010974720ULL,687194767360ULL,0ULL,4611686018427387904ULL,22548578304ULL,0ULL,13528391068155904ULL,36204718879408128ULL,1152921504606846976ULL,0ULL,10737418240ULL,21474836480ULL,54043195528445952ULL,211106232532992ULL,0ULL,228698418577408ULL,14025752576ULL,17582522368ULL,687194767360ULL,35459249995776ULL,4611721202799476736ULL,17592186044416ULL,0ULL,57445187584ULL,35184372088832ULL,9232379785865330688ULL,0ULL,9223372036854775808ULL,34359738368ULL,0ULL,35734127902720ULL,206158430208ULL,1157425104234217472ULL,9007199254740992ULL,34359738368ULL,11274289152ULL,70368744177664ULL,140737488355328ULL,87960930222080ULL,4611686018427387904ULL,1073741824ULL,0ULL,824633720832ULL,68719476736ULL,211930866253824ULL,0ULL,0ULL,67108864ULL,2314850345907388416ULL,1152921573326323712ULL,1152921504606846976ULL,4611686018427387904ULL,0ULL,34359738368ULL,2314850345907388416ULL,0ULL,4611686018427387904ULL,3458764513820540928ULL,0ULL,34359738368ULL,54043195528445952ULL,211655988346880ULL,0ULL,18243096928059392ULL,402653184ULL,8657043456ULL,70368744177664ULL,54043195528445952ULL,4611914716845965312ULL,0ULL,17179869184ULL,5368709120ULL,549755813888ULL,412316860416ULL,52776558133248ULL,137438953472ULL,67108864ULL,0ULL,35184372088832ULL,0ULL,2305860601399738368ULL,35184372088832ULL,56371445760ULL,0ULL,274877906944ULL,618475290624ULL,18226054497828864ULL,35596688949248ULL,67108864ULL,0ULL,13510798882111488ULL,36081573577097216ULL,1188950301625810944ULL,22517998136852480ULL,4294967296ULL,27917287424ULL,35184372088832ULL,9007749010554880ULL,4616189618054758400ULL,11538222245323210752ULL,9126805504ULL,34628173824ULL,9007749010554880ULL,35253091565568ULL,9007199254740992ULL,4503599627370496ULL,34628173824ULL,536870912ULL,274877906944ULL,687194767360ULL,17592186044416ULL,35184372088832ULL,57646514176ULL,0ULL,194063802302464ULL,206158430208ULL,1175439502743699456ULL,0ULL,10737418240ULL,0ULL,53326313947136ULL,70574902607872ULL,0ULL,18031990695526400ULL,11140071424ULL,67108864ULL,5764607591753711616ULL,9043345699504128ULL,0ULL,4611686018427387904ULL,0ULL,34359738368ULL,137438953472ULL,35734127902720ULL,6926536226895822848ULL,1157425104234217472ULL,536870912ULL,34359738368ULL,35184372088832ULL,9007199254740992ULL,11529215046068469760ULL,4611686018427387904ULL,9126805504ULL,17448304640ULL,206158430208ULL,549755813888ULL,17592186044416ULL,9007199254740992ULL,0ULL,11005853696ULL,549755813888ULL,274877906944ULL,18031990695526400ULL,105553116266496ULL,134217728ULL,0ULL,13651536370466816ULL,36081573577097216ULL,22517998136852480ULL,36028797018963968ULL,12884901888ULL,19327352832ULL,49539595901075456ULL,194063802302464ULL,40532396646334464ULL,18014398509481984ULL,0ULL,8589934592ULL,140737488355328ULL,0ULL,1175668201162276864ULL,13871086852301127680ULL,17179869184ULL,4294967296ULL,549755813888ULL,0ULL,11592265440851656704ULL,4611914716845965312ULL,268435456ULL,8589934592ULL,52776558133248ULL,70368744177664ULL,0ULL,17592186044416ULL,67108864ULL,12213813248ULL};
        std::vector<B3> initial_data = {};
        for (int i = 0; i < data_raw.size(); i+=2) initial_data.push_back(B3{data_raw[i], data_raw[i+1]});
        
        int initial_rank = get_rank(initial_data);
        
        std::cout << "=== Pool-based " << n << "x" << n 
                  << " Matrix Multiplication Search ===\n";
        std::cout << "Field: " << (field_traits<Field>::is_mod2 ? "mod2" : "mod3") << "\n";
        std::cout << "Path limit: " << path_limit 
                  << ", Pool size: " << pool_size
                  << ", Target rank: " << target_rank
                  << ", Threads: " << threads;
        if (use_plus) {
            std::cout << ", Plus transitions: enabled (limit: " << plus_lim << ")";
        } else {
            std::cout << ", Plus transitions: disabled";
        }
        std::cout << "\n\n";
        
        // Initialize with starting scheme
        current_pool.push_back(SchemeData<Field>(initial_data, initial_rank, 0));
        
        // Save initial pool if enabled
        if (save_pools) {
            save_pool(current_pool, initial_rank, n);
        }
        
        std::cout << "Starting from rank " << initial_rank << "\n\n";
        
        // Search for progressively lower ranks
        for (int current_target = initial_rank - 1; 
             current_target >= target_rank; 
             --current_target) {
            
            std::cout << "=== Searching for rank " << current_target << " ===\n";
            
            next_pool.clear();
            stop_workers = false;
            attempts_made = 0;
            
            auto start_time = std::chrono::steady_clock::now();
            
            // Start worker threads
            std::vector<std::thread> workers;
            for (int i = 0; i < threads; ++i) {
                workers.emplace_back(&PoolSearch::worker, this);
            }
            
            // Wait until we have enough schemes or hit attempt limit
            while (next_pool.size() < pool_size && attempts_made < max_attempts) {
                std::this_thread::sleep_for(std::chrono::milliseconds(100));
                pool_cv.notify_all();
                
                // Periodic status update
                if (attempts_made > 0 && attempts_made % 100 == 0) {
                    std::cout << "  Attempts: " << attempts_made 
                              << ", Found: " << next_pool.size() 
                              << "/" << pool_size << "\r" << std::flush;
                }
            }
            std::cout << "\n";
            
            // Stop workers
            stop_workers = true;
            pool_cv.notify_all();
            for (auto& w : workers) {
                w.join();
            }
            
            auto end_time = std::chrono::steady_clock::now();
            double secs = std::chrono::duration<double>(end_time - start_time).count();
            
            std::cout << "Completed " << attempts_made << " attempts in " 
                      << std::fixed << std::setprecision(1) << secs << "s\n";
            std::cout << "Found " << next_pool.size() << " schemes of rank " 
                      << current_target << "\n";
            
            if (next_pool.empty()) {
                std::cout << "Failed to find schemes of rank " << current_target 
                          << " after " << attempts_made << " attempts\n";
                break;
            }
            
            // Verify schemes
            int verified = 0;
            for (const auto& scheme : next_pool) {
                if (verify_scheme(scheme.data, n)) {
                    verified++;
                }
            }
            std::cout << "Verified: " << verified << "/" << next_pool.size() << "\n\n";
            
            // Save pool if enabled
            if (save_pools && !next_pool.empty()) {
                save_pool(next_pool, current_target, n);
            }
            
            // Move to next level
            current_pool = std::move(next_pool);
            
            // Keep only diverse subset if pool is too large
            if (current_pool.size() > pool_size) {
                std::shuffle(current_pool.begin(), current_pool.end(), seed_gen);
                current_pool.erase(current_pool.begin() + pool_size, current_pool.end());
            }
        }
        
        // Output best result
        if (!current_pool.empty()) {
            std::cout << "\n=== Final Results ===\n";
            std::cout << "Best rank achieved: " << current_pool[0].rank << "\n";
            std::cout << "Pool size at best rank: " << current_pool.size() << "\n";
        }
    }
};

int main(int argc, char* argv[]) {
    CLI::App app{"Pool-based Matrix Multiplication Flip Graph Search"};
    
    // Parameters
    int n = 4;
    int path_limit = 1000000;
    int pool_size = 200;
    int target_rank = 0;
    int plus_lim = 50000;
    int threads = 4;
    int max_attempts = 1000;
    bool use_plus = false;  // Default: plus transitions disabled
    bool save_pools = false; // Default: saving disabled
    
    app.add_option("-n,--size", n, "Matrix size (nxn)")
        ->default_val(4)->check(CLI::PositiveNumber);
    app.add_option("-f,--path-limit", path_limit, "Path length limit")
        ->default_val(1000000);
    app.add_option("-s,--pool-size", pool_size, "Pool size limit")
        ->default_val(200);
    app.add_option("-r,--target-rank", target_rank, "Target rank")
        ->default_val(0);
    app.add_option("-p,--plus-lim", plus_lim, "Flips before plus transition")
        ->default_val(50000);
    app.add_option("-t,--threads", threads, "Number of worker threads")
        ->default_val(4)->check(CLI::PositiveNumber);
    app.add_option("-m,--max-attempts", max_attempts, "Max attempts per rank level")
        ->default_val(1000)->check(CLI::PositiveNumber);
    app.add_flag("--plus", use_plus, "Enable plus transitions");
    app.add_flag("--save", save_pools, "Save pools to files");
    
    CLI11_PARSE(app, argc, argv);
    
    PoolSearch<FieldType> search(n, path_limit, pool_size, target_rank, 
                                  plus_lim, threads, max_attempts, use_plus, save_pools);
    search.run();
    
    return 0;
}